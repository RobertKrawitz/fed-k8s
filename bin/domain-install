#!/bin/bash

: ${DRYRUN:=}

set -eu

for i in "$@"; do
    name=${PREFIX:?oops}-vm-${i}
    config_drive="/tmp/${name}-ds.iso"
    $DRYRUN ./create-config-drive \
	--domainname=$DOMAINNAME \
	--hostname=$name \
	--ssh-key=$HOME/.ssh/id_rsa.pub	\
	--user-data=$USER_DATA \
	$config_drive
    $DRYRUN virsh pool-refresh default
    $DRYRUN virsh vol-delete --pool default $(basename $config_drive)
    $DRYRUN virsh vol-create-as --pool default $(basename $config_drive) $(stat -Lc%s $config_drive) --format raw
    $DRYRUN virsh vol-upload --pool default $(basename $config_drive) $config_drive
    $DRYRUN virsh vol-clone --pool default ${CLOUD_IMG:-Fedora-Cloud-Base-26-1.5.x86_64.qcow2} ${name}.qcow2
    $DRYRUN virsh vol-resize --pool default ${name}.qcow2 +50G
    $DRYRUN virt-install -r 4096 \
	    --os-variant=${OS_VARIANT:-rhel7.4} \
	    -n $name \
	    --vcpus=2 \
	    --noautoconsole \
	    --memballoon virtio \
	    --boot hd \
	    --disk vol=default/${name}.qcow2,format=qcow2,bus=virtio,cache=writeback,size=${DISK_SIZE:-50} \
	    --disk vol=default/$(basename $config_drive),bus=virtio \
	    --network network=${NETWORK:?nonet},model=virtio
done
